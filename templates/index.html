<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SmartQ - Ollamaã‚’æ´»ç”¨ã—ãŸAIã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒª">
    <title>SmartQ - ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãªã‚¯ã‚¤ã‚ºã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</title>
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-hover: #3a56d4;
            --secondary-color: #f8f9fa;
            --accent-color: #4cc9f0;
            --text-color: #333;
            --light-text: #6c757d;
            --border-color: #e2e8f0;
            --success-color: #4caf50;
            --error-color: #f44336;
            --warning-color: #ff9800;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
             height: 100%; /* htmlè¦ç´ ã®é«˜ã•ã‚’100%ã« */
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f5f7fa;
            padding: 20px;
            display: flex; /* Flexboxã‚’bodyã«é©ç”¨ */
            flex-direction: column; /* å­è¦ç´ ã‚’ç¸¦æ–¹å‘ã«ä¸¦ã¹ã‚‹ */
            min-height: 100%; /* bodyã®é«˜ã•ã‚’æœ€ä½ã§ã‚‚ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®é«˜ã•ã« */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%; /* ã‚³ãƒ³ãƒ†ãƒŠå¹…ã‚’100%ã« */
            flex: 1; /* åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’åŸ‹ã‚ã‚‹ */
            display: flex; /* Flexboxã‚’containerã«é©ç”¨ */
            flex-direction: column; /* containerå†…ã®è¦ç´ ã‚‚ç¸¦ã« */
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            flex-shrink: 0; /* ãƒ˜ãƒƒãƒ€ãƒ¼ãŒç¸®ã¾ãªã„ã‚ˆã†ã« */
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .tagline {
            font-size: 1.2rem;
            color: var(--light-text);
            margin-bottom: 20px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 30px;
            flex-grow: 1; /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒåˆ©ç”¨å¯èƒ½ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’åŸ‹ã‚ã‚‹ */
            margin-bottom: 30px;
        }

        .panel {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            padding: 25px;
            transition: var(--transition);
            display: flex; /* ãƒ‘ãƒãƒ«å†…ã§Flexboxã‚’ä½¿ç”¨ */
            flex-direction: column; /* ãƒ‘ãƒãƒ«å†…ã®è¦ç´ ã‚’ç¸¦æ–¹å‘ã«é…ç½® */
        }

        .panel-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            flex-shrink: 0; /* ã‚¿ã‚¤ãƒˆãƒ«ãŒç¸®ã¾ãªã„ã‚ˆã†ã« */
        }

        .form-group {
            margin-bottom: 20px;
        }
        /* çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’å«ã‚€ãƒ•ã‚©ãƒ¼ãƒ ã‚°ãƒ«ãƒ¼ãƒ—ãŒä¼¸ã³ã‚‹ã‚ˆã†ã« */
        .form-group.flex-grow {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .form-group.flex-grow textarea {
             flex-grow: 1; /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢è‡ªä½“ã‚‚ä¼¸ã³ã‚‹ã‚ˆã†ã« */
             min-height: 150px; /* æœ€å°é«˜ã•ã‚’ç¢ºä¿ */
        }


        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        /* input[type="text"] ãªã©ã®å…·ä½“çš„ãªæŒ‡å®š */
        select, textarea, button, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
            transition: var(--transition);
        }

        select {
            appearance: none; /* OSæ¨™æº–ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç„¡åŠ¹åŒ– */
            background-color: white;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill="%23333" d="M8 11.414l-4.707-4.707a1 1 0 0 1 1.414-1.414L8 8.586l3.293-3.293a1 1 0 1 1 1.414 1.414L8 11.414z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px; /* ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¹ãƒšãƒ¼ã‚¹ */
            cursor: pointer;
        }

        select:hover, textarea:hover, input[type="text"]:hover {
            border-color: var(--primary-color);
        }

        select:focus, textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        #systemPrompt {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        #knowledgeInput {
            /* min-heightã¯.form-group.flex-grow textareaã§è¨­å®š */
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            border: none;
            padding: 14px;
            margin-top: 10px;
            transition: var(--transition);
        }

        /* :disabledã§ãªã„æ™‚ã®ã¿hover/activeåŠ¹æœã‚’é©ç”¨ */
        button:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background-color: var(--light-text);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7; /* ç„¡åŠ¹çŠ¶æ…‹ã‚’è¦–è¦šçš„ã«ç¤ºã™ */
        }

        .question-display {
            background-color: var(--secondary-color);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            border-left: 4px solid var(--primary-color);
            line-height: 1.7; /* å•é¡Œæ–‡ã®è¡Œé–“èª¿æ•´ */
        }

        .option-group {
            margin-bottom: 25px;
            border: none; /* fieldsetã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒœãƒ¼ãƒ€ãƒ¼ã‚’æ¶ˆã™ */
            padding: 0; /* fieldsetã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¶ˆã™ */
        }

        /* labelè¦ç´ ã«å¤‰æ›´ */
        .option-label {
            display: flex;
            align-items: flex-start; /* ãƒ†ã‚­ã‚¹ãƒˆãŒè¤‡æ•°è¡Œã«ãªã£ã¦ã‚‚radioãŒä¸Šéƒ¨ã«æƒã† */
            margin-bottom: 12px;
            padding: 15px;
            background-color: white; /* èƒŒæ™¯ã‚’ç™½ã«å¤‰æ›´ */
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            cursor: pointer;
        }

        .option-label:hover {
            background-color: #e9ecef;
            border-color: var(--primary-color);
        }

        /* é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ©ãƒ™ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .option-label.selected {
            background-color: #e8f0fe;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2); /* é¸æŠã‚’ã‚ˆã‚Šæ˜ç¢ºã« */
        }
        /* ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã«ç¶šããƒ†ã‚­ã‚¹ãƒˆã‚’å¤ªå­—ã« */
        input[type="radio"]:checked + .option-text {
             font-weight: 600;
        }


        .option-radio {
            margin-right: 15px;
            margin-top: 3px; /* å¾®èª¿æ•´ */
            width: 18px; /* ã‚µã‚¤ã‚ºèª¿æ•´ */
            height: 18px;
            flex-shrink: 0; /* labelãƒªã‚µã‚¤ã‚ºæ™‚ã«ç¸®ã¾ãªã„ã‚ˆã†ã« */
            cursor: pointer;
            accent-color: var(--primary-color); /* å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®è‰²ã‚’å¤‰æ›´ */
        }

        .option-text {
            flex: 1;
        }

        .feedback-container {
            margin-top: 25px;
            padding: 20px;
            border-radius: var(--border-radius);
            background-color: #f8f9fa;
            display: none; /* åˆæœŸçŠ¶æ…‹éè¡¨ç¤º */
            opacity: 0;
            transition: opacity 0.5s ease;
            overflow: hidden;
        }

        .feedback-container.visible {
            display: block;
            opacity: 1;
            animation: fadeIn 0.5s ease-out; /* fadeInã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ */
        }

        .feedback-header {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--text-color);
            font-weight: 600;
        }

        .feedback-content {
            line-height: 1.7;
        }

        .feedback-correct {
            border-left: 4px solid var(--success-color);
            background-color: #e8f5e9; /* æ­£è§£æ™‚ã®èƒŒæ™¯è‰² */
        }

        .feedback-incorrect {
            border-left: 4px solid var(--error-color);
            background-color: #ffebee; /* ä¸æ­£è§£æ™‚ã®èƒŒæ™¯è‰² */
        }

        .section-header { /* legendãªã© */
            font-size: 1.2rem;
            margin: 15px 0 8px 0;
            color: var(--text-color);
            font-weight: 600; /* å°‘ã—å¼·èª¿ */
        }

        /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å†…ã®å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .explanation, .user-response, .additional-resources {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px; /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–“ã®ãƒãƒ¼ã‚¸ãƒ³ */
            background-color: white; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèƒŒæ™¯ã‚’ç™½ã« */
        }
        .explanation strong { /* èª¬æ˜ã®å¼·èª¿éƒ¨åˆ† */
            color: var(--primary-color);
            font-weight: 600;
        }
        .explanation {
             border-left: 3px solid var(--primary-color);
        }

        .user-response {
            background-color: #f0f7ff;
            border-left: 3px solid var(--accent-color);
        }
        .user-response h4 {
            margin: 0 0 8px 0;
            color: var(--accent-color);
            font-size: 1rem;
        }

        .additional-resources {
            background-color: #f0fdf4;
            border-left: 3px solid var(--success-color);
        }
        .additional-resources h4 {
            margin: 0 0 8px 0;
            color: var(--success-color);
            font-size: 1rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px 0; /* ä¸Šä¸‹ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã®ã¿ */
            color: var(--light-text);
        }

        .loading.visible {
            display: block;
        }

        .loading .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 10px;
        }
        .loading p {
            font-size: 0.9rem;
            margin: 0;
        }

        .error-message {
            background-color: #ffebee;
            color: var(--error-color);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            border-left: 3px solid var(--error-color);
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .error-message.visible {
            display: block;
            opacity: 1;
            animation: fadeIn 0.3s ease-out;
        }
        .error-message p {
            margin: 0;
            line-height: 1.5;
        }
        .error-message strong { /* ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒˆãƒ« */
             display: block;
             margin-bottom: 5px;
             font-weight: 600;
        }
        .error-message code { /* ã‚¨ãƒ©ãƒ¼è©³ç´°ç”¨ */
            font-size: 0.85rem;
            background-color: rgba(0,0,0,0.05);
            padding: 2px 4px;
            border-radius: 3px;
            word-break: break-all; /* é•·ã„ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ˜ã‚Šè¿”ã™ */
        }

        .button-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-shrink: 0; /* ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠãŒç¸®ã¾ãªã„ã‚ˆã†ã« */
        }

        .button-container button {
            flex: 1; /* ãƒœã‚¿ãƒ³å¹…ã‚’å‡ç­‰ã« */
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-bottom: 20px;
            color: var(--light-text);
            font-size: 0.9rem;
            flex-shrink: 0; /* ãƒ•ãƒƒã‚¿ãƒ¼ãŒç¸®ã¾ãªã„ã‚ˆã†ã« */
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr; /* 1ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã« */
            }
            h1 {
                font-size: 2rem;
            }
            .panel {
                padding: 20px;
            }
        }

        @media (max-width: 600px) { /* ä¸­é–“ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆ */
             body {
                 padding: 15px;
             }
             .panel {
                 padding: 15px;
             }
              #systemPrompt { min-height: 150px; }
        }


        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            h1 {
                font-size: 1.8rem;
            }
            .option-label {
                padding: 12px;
            }
            .option-radio {
                margin-right: 10px;
            }
            .tagline {
                font-size: 1rem;
            }
             /* ã‚¹ãƒãƒ›ã§ã¯ãƒœã‚¿ãƒ³ã‚’ç¸¦ç©ã¿ã« */
             .button-container {
                 flex-direction: column;
             }
             .button-container button {
                  width: 100%; /* å¹…ã‚’100%ã« */
             }
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SmartQ</h1>
            <p class="tagline">AIãŒç”Ÿæˆã™ã‚‹ã‚¯ã‚¤ã‚ºã§çŸ¥è­˜ã®å¹…ã‚’åºƒã’ã‚ˆã†</p>
        </header>

        <main class="main-content">
            <!-- å·¦å´ãƒ‘ãƒãƒ« - è¨­å®š -->
            <section class="panel" id="settingsPanel" aria-labelledby="settingsTitle">
                <h2 class="panel-title" id="settingsTitle">è¨­å®š</h2>

                <div class="form-group">
                    <label for="difficulty">é›£æ˜“åº¦</label>
                    <select id="difficulty" aria-label="ã‚¯ã‚¤ã‚ºã®é›£æ˜“åº¦">
                        <option value="easy">åˆç´š</option>
                        <option value="medium" selected>ä¸­ç´š</option>
                        <option value="hard">ä¸Šç´š</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="systemPrompt">ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (AIã¸ã®æŒ‡ç¤º)</label>
                    <textarea id="systemPrompt" aria-label="AIã¸ã®æŒ‡ç¤º">ã‚ãªãŸã¯æ•™è‚²ç›®çš„ã®ã‚¯ã‚¤ã‚ºä½œæˆAIã§ã™ã€‚
ä»¥ä¸‹ã®æ¡ä»¶ã§å•é¡Œã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š
1. æä¾›ã•ã‚ŒãŸçŸ¥è­˜ã‚’ãƒ™ãƒ¼ã‚¹ã«é–¢é€£ã™ã‚‹å•é¡Œã‚’1ã¤ä½œæˆã™ã‚‹
2. å•é¡Œã¯æ˜ç¢ºã§ç†è§£ã—ã‚„ã™ã„ã‚‚ã®ã«ã™ã‚‹
3. 4ã¤ã®é¸æŠè‚¢ã‚’æä¾›ã™ã‚‹ï¼ˆ1ã¤ã®æ­£è§£ã¨3ã¤ã®èª¤ç­”ï¼‰
4. é¸æŠè‚¢ã¯A, B, C, Dã§ãƒ©ãƒ™ãƒ«ä»˜ã‘ã™ã‚‹
5. æ­£è§£ã®é¸æŠè‚¢ã‚’æ˜ç¤ºçš„ã«ãƒãƒ¼ã‚¯ã™ã‚‹

å‡ºåŠ›å½¢å¼ï¼ˆä»¥ä¸‹ã®å½¢å¼ã‚’å³å®ˆã—ã¦ãã ã•ã„ï¼‰ï¼š
å•é¡Œ: [å•é¡Œæ–‡]
A: [é¸æŠè‚¢A]
B: [é¸æŠè‚¢B]
C: [é¸æŠè‚¢C]
D: [é¸æŠè‚¢D]
æ­£è§£: [æ­£è§£ã®é¸æŠè‚¢ã®ãƒ©ãƒ™ãƒ« (A, B, C, D ã®ã„ãšã‚Œã‹1æ–‡å­—)]</textarea>
                </div>

                <!-- flex-grow ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã—ã¦é«˜ã•ã‚’å¯å¤‰ã« -->
                <div class="form-group flex-grow">
                    <label for="knowledgeInput">çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ï¼ˆå•é¡Œã®å…ƒã¨ãªã‚‹æƒ…å ±ã‚’å…¥åŠ›ï¼‰</label>
                    <textarea id="knowledgeInput" aria-label="å•é¡Œã®å…ƒã¨ãªã‚‹çŸ¥è­˜ã‚„æƒ…å ±" placeholder="ã“ã“ã«çŸ¥è­˜ã‚„æƒ…å ±ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãã‚Œã«åŸºã¥ã„ãŸå•é¡ŒãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ãƒ†ã‚­ã‚¹ãƒˆã€æ–‡ç« ã€äº‹å®Ÿãªã©è‡ªç”±ã«å…¥åŠ›ã§ãã¾ã™ã€‚"></textarea>
                </div>

                <div class="button-container">
                    <button id="generateBtn" aria-label="å•é¡Œã‚’ç”Ÿæˆã™ã‚‹">å•é¡Œã‚’ç”Ÿæˆã™ã‚‹</button>
                </div>

                <div class="loading" id="loadingGenerate" role="status" aria-live="polite">
                    <div class="spinner" aria-hidden="true"></div>
                    <p>å•é¡Œã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...</p>
                </div>

                <div class="error-message" id="generateError" role="alert" aria-live="assertive">
                    <p><strong>ã‚¨ãƒ©ãƒ¼</strong> å•é¡Œã®ç”Ÿæˆä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>
                    <p><code id="generateErrorDetails"></code></p>
                </div>
            </section>

            <!-- å³å´ãƒ‘ãƒãƒ« - ã‚¯ã‚¤ã‚ºã¨å›ç­” -->
            <section class="panel" id="quizPanel" aria-labelledby="quizTitle">
                <h2 class="panel-title" id="quizTitle">ã‚¯ã‚¤ã‚º</h2>

                <div id="quizContainer" style="display: none;">
                    <div class="question-display" aria-live="polite">
                        <p id="questionText"></p>
                    </div>

                    <!-- fieldset ã¨ legend ã‚’ä½¿ç”¨ -->
                    <fieldset class="option-group" role="radiogroup" aria-labelledby="optionsLabel">
                        <legend id="optionsLabel" class="section-header">é¸æŠè‚¢</legend>

                        <!-- labelè¦ç´ ã§ãƒ©ãƒƒãƒ—ã—ã€forå±æ€§ã§é–¢é€£ä»˜ã‘ -->
                        <label class="option-label" id="optionAContainer" for="radioA">
                            <input type="radio" name="quizOption" id="radioA" class="option-radio" value="A" aria-labelledby="optionAText">
                            <span class="option-text" id="optionAText">é¸æŠè‚¢ A</span>
                        </label>

                        <label class="option-label" id="optionBContainer" for="radioB">
                            <input type="radio" name="quizOption" id="radioB" class="option-radio" value="B" aria-labelledby="optionBText">
                            <span class="option-text" id="optionBText">é¸æŠè‚¢ B</span>
                        </label>

                        <label class="option-label" id="optionCContainer" for="radioC">
                            <input type="radio" name="quizOption" id="radioC" class="option-radio" value="C" aria-labelledby="optionCText">
                            <span class="option-text" id="optionCText">é¸æŠè‚¢ C</span>
                        </label>

                        <label class="option-label" id="optionDContainer" for="radioD">
                            <input type="radio" name="quizOption" id="radioD" class="option-radio" value="D" aria-labelledby="optionDText">
                            <span class="option-text" id="optionDText">é¸æŠè‚¢ D</span>
                        </label>
                    </fieldset>

                    <div class="form-group">
                        <label for="userInput">è¿½åŠ å›ç­”/è³ªå• (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
                        <textarea id="userInput" placeholder="å›ç­”ã«å¯¾ã™ã‚‹è£œè¶³ã‚„è³ªå•ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„" aria-label="è¿½åŠ ã®å›ç­”ã‚„è³ªå•"></textarea>
                    </div>

                    <div class="button-container">
                        <button id="submitBtn" aria-label="å›ç­”ã‚’é€ä¿¡ã™ã‚‹">å›ç­”ã‚’é€ä¿¡ã™ã‚‹</button>
                        <button id="nextQuestionBtn" aria-label="æ¬¡ã®å•é¡Œã¸">æ¬¡ã®å•é¡Œã¸</button>
                    </div>

                    <div class="loading" id="loadingSubmit" role="status" aria-live="polite">
                        <div class="spinner" aria-hidden="true"></div>
                        <p>å›ç­”ã‚’è©•ä¾¡ã—ã¦ã„ã¾ã™...</p>
                    </div>

                    <div class="error-message" id="submitError" role="alert" aria-live="assertive">
                        <p><strong>ã‚¨ãƒ©ãƒ¼</strong> å›ç­”ã®è©•ä¾¡ä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>
                        <p><code id="submitErrorDetails"></code></p>
                    </div>

                    <div class="feedback-container" id="feedbackContainer" aria-live="polite">
                        <h3 class="feedback-header" id="feedbackHeader">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h3>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                </div>

                <!-- åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                <div id="initialMessage" style="text-align: center; padding: 40px 20px; flex-grow: 1; display: flex; align-items: center; justify-content: center;">
                    <p style="color: var(--light-text);">å·¦å´ã®ãƒ‘ãƒãƒ«ã‹ã‚‰å•é¡Œã®è¨­å®šã¨çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‚’å…¥åŠ›ã—ã€ã€Œå•é¡Œã‚’ç”Ÿæˆã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            </section>
        </main>

        <footer>
            <p>Â© 2025 SmartQ - ã‚¹ãƒãƒ¼ãƒˆã«ã‚¯ã‚¤ã‚ºã§å­¦ã¶ã€æ–°ã—ã„å­¦ç¿’ä½“é¨“ã€‚</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- å®šæ•°å®šç¾© ---
            const API_ENDPOINTS = {
                // ãƒ­ãƒ¼ã‚«ãƒ«Ollama APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (ç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´)
                // generate: '/api/proxy/generate', // ä¾‹: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ—ãƒ­ã‚­ã‚·çµŒç”±
                // evaluate: '/api/proxy/evaluate', // ä¾‹: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ—ãƒ­ã‚­ã‚·çµŒç”±
                generate: 'http://localhost:11434/api/generate', // ç›´æ¥æ¥ç¶š (CORSè¨­å®šæ³¨æ„)
                evaluate: 'http://localhost:11434/api/generate' // ç›´æ¥æ¥ç¶š (CORSè¨­å®šæ³¨æ„)
            };
            const OLLAMA_MODEL = 'llama3'; // ä½¿ç”¨ã™ã‚‹Ollamaãƒ¢ãƒ‡ãƒ«å
            const API_TIMEOUT = 30000; // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ (ãƒŸãƒªç§’)

            // --- DOMè¦ç´ ã®å‚ç…§ ---
            const settingsPanel = document.getElementById('settingsPanel');
            const difficultySelect = document.getElementById('difficulty');
            const systemPromptTextarea = document.getElementById('systemPrompt');
            const knowledgeInput = document.getElementById('knowledgeInput');
            const generateBtn = document.getElementById('generateBtn');
            const submitBtn = document.getElementById('submitBtn');
            const nextQuestionBtn = document.getElementById('nextQuestionBtn');
            const questionText = document.getElementById('questionText');
            const optionLabels = { // labelè¦ç´ ã‚’å‚ç…§
                A: document.getElementById('optionAContainer'),
                B: document.getElementById('optionBContainer'),
                C: document.getElementById('optionCContainer'),
                D: document.getElementById('optionDContainer')
            };
            const optionTexts = { // spanè¦ç´ ã‚’å‚ç…§
                A: document.getElementById('optionAText'),
                B: document.getElementById('optionBText'),
                C: document.getElementById('optionCText'),
                D: document.getElementById('optionDText')
            };
            const radioInputs = document.querySelectorAll('.option-radio');
            const userInput = document.getElementById('userInput');
            const quizContainer = document.getElementById('quizContainer');
            const initialMessage = document.getElementById('initialMessage');
            const loadingGenerate = document.getElementById('loadingGenerate');
            const loadingSubmit = document.getElementById('loadingSubmit');
            const generateError = document.getElementById('generateError');
            const generateErrorDetails = document.getElementById('generateErrorDetails');
            const submitError = document.getElementById('submitError');
            const submitErrorDetails = document.getElementById('submitErrorDetails');
            const feedbackContainer = document.getElementById('feedbackContainer');
            const feedbackHeader = document.getElementById('feedbackHeader');
            const feedbackContent = document.getElementById('feedbackContent');
            const optionGroup = document.querySelector('.option-group'); // fieldset

            // --- çŠ¶æ…‹ç®¡ç† ---
            const appState = {
                currentQuiz: { question: "", options: {}, correctAnswer: "" },
                userSelection: null,
                status: 'initial', // 'initial', 'generating', 'generated', 'submitting', 'submitted', 'error_generate', 'error_submit'
                generateAbortController: null, // å•é¡Œç”Ÿæˆç”¨AbortController
                evaluateAbortController: null, // è©•ä¾¡ç”¨AbortController
            };

            // --- UIæ›´æ–°é–¢æ•° ---
            function updateUIState(newState) {
                const previousState = appState.status;
                appState.status = newState;
                console.log(`State changed: ${previousState} -> ${newState}`); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                loadingGenerate.classList.toggle('visible', newState === 'generating');
                loadingSubmit.classList.toggle('visible', newState === 'submitting');

                // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
                generateError.classList.remove('visible');
                submitError.classList.remove('visible');
                generateErrorDetails.textContent = ''; // ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚‚ã‚¯ãƒªã‚¢
                submitErrorDetails.textContent = '';

                // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹
                generateBtn.disabled = newState === 'generating' || newState === 'submitting';
                submitBtn.disabled = !(newState === 'generated' && appState.userSelection !== null); // ç”Ÿæˆæ¸ˆã¿ã‹ã¤é¸æŠè‚¢ãŒé¸ã°ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿æœ‰åŠ¹
                nextQuestionBtn.disabled = newState !== 'submitted';

                // ãƒ‘ãƒãƒ«è¡¨ç¤ºåˆ¶å¾¡
                 quizContainer.style.display = (newState !== 'initial' && newState !== 'generating' && newState !== 'error_generate') ? 'block' : 'none';
                 initialMessage.style.display = (newState === 'initial' || newState === 'generating' || newState === 'error_generate') ? 'flex' : 'none'; // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯flexã§ä¸­å¤®æƒãˆ

                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
                feedbackContainer.classList.toggle('visible', newState === 'submitted');

                // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ“ä½œå¯å¦
                const isOptionsEnabled = newState === 'generated';
                radioInputs.forEach(input => input.disabled = !isOptionsEnabled);
                Object.values(optionLabels).forEach(label => {
                    label.style.cursor = isOptionsEnabled ? 'pointer' : 'default';
                    label.style.opacity = isOptionsEnabled ? '1' : '0.7';
                    if (!isOptionsEnabled) {
                         label.classList.remove('selected'); // æ“ä½œä¸å¯ãªã‚‰é¸æŠçŠ¶æ…‹ã‚‚è§£é™¤
                    }
                });

                // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®è¡¨ç¤º
                if (newState === 'error_generate') generateError.classList.add('visible');
                if (newState === 'error_submit') submitError.classList.add('visible');

                // çŠ¶æ…‹é·ç§»ã«å¿œã˜ãŸãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç®¡ç† (ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š)
                if (newState === 'generated' && previousState !== 'generated') {
                     radioInputs[0]?.focus(); // æœ€åˆã®é¸æŠè‚¢ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                 } else if (newState === 'submitted' && previousState !== 'submitted') {
                     nextQuestionBtn?.focus(); // æ¬¡ã®å•é¡Œãƒœã‚¿ãƒ³ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                 } else if (newState === 'initial' && previousState !== 'initial') {
                     generateBtn?.focus(); // åˆæœŸçŠ¶æ…‹ã«æˆ»ã£ãŸã‚‰ç”Ÿæˆãƒœã‚¿ãƒ³ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                 }
            }

            // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---

            // ãƒ†ã‚­ã‚¹ãƒˆã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆç°¡æ˜“ç‰ˆ - è¡¨ç¤ºç”¨ï¼‰
            function sanitizeText(text) {
                 if (typeof text !== 'string') return '';
                 const tempDiv = document.createElement('div');
                 tempDiv.textContent = text;
                 return tempDiv.innerHTML.replace(/\n/g, '<br>'); // æ”¹è¡Œã‚’<br>ã«å¤‰æ›
            }

            // å®‰å…¨ã«HTMLã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (ã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ¸ˆã¿ãƒ†ã‚­ã‚¹ãƒˆç”¨)
            function safeRenderHTML(container, sanitizedHtmlString) {
                 // æ³¨æ„: ã“ã®é–¢æ•°ã¯å…¥åŠ›ãŒæ—¢ã«ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¾ã™ã€‚
                 // DOMPurifyãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã®ãŒæœ€ã‚‚å®‰å…¨ã§ã™ã€‚
                 container.innerHTML = sanitizedHtmlString;
            }

            // AIå¿œç­”ã‹ã‚‰å•é¡Œæƒ…å ±ã‚’ãƒ‘ãƒ¼ã‚¹
             function parseQuestionResponse(response) {
                 const lines = response.trim().split('\n');
                 const result = { question: "", options: { A: "", B: "", C: "", D: "" }, correctAnswer: "" };
                 let currentOption = null;

                 for (const line of lines) {
                     const trimmedLine = line.trim();
                     if (trimmedLine.startsWith("å•é¡Œ:")) {
                         result.question = trimmedLine.substring(3).trim();
                     } else if (trimmedLine.match(/^([A-D]):/)) {
                         const key = RegExp.$1;
                         result.options[key] = trimmedLine.substring(2).trim();
                     } else if (trimmedLine.startsWith("æ­£è§£:")) {
                         // æ­£è§£ãƒ©ãƒ™ãƒ« (A, B, C, D) ã®ã¿æŠ½å‡º
                         const match = trimmedLine.substring(3).trim().match(/^[A-D]/);
                         if (match) {
                             result.correctAnswer = match[0];
                         }
                     }
                 }
                // console.log("Parsed Question:", result); // ãƒ‡ãƒãƒƒã‚°ç”¨

                 // å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
                 if (!result.question || !result.options.A || !result.options.B || !result.options.C || !result.options.D || !['A', 'B', 'C', 'D'].includes(result.correctAnswer)) {
                     console.error("ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: å¿…é ˆæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚", result, "å…ƒãƒ¬ã‚¹ãƒãƒ³ã‚¹: ", response);
                     throw new Error("AIã®å¿œç­”å½¢å¼ãŒä¸æ­£ã§ã™ã€‚å•é¡Œã€é¸æŠè‚¢Aã€œDã€æ­£è§£(A/B/C/D)ã‚’æ­£ã—ãæŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
                 }
                 return result;
             }

             // AIå¿œç­”ã‹ã‚‰è©•ä¾¡æƒ…å ±ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆã‚ˆã‚ŠæŸ”è»Ÿã«ï¼‰
             function parseEvaluationResponse(response) {
                 const lines = response.trim().split('\n');
                 const result = {
                     judgement: "ä¸æ˜", // 'æ­£è§£', 'ä¸æ­£è§£', 'ä¸æ˜'
                     explanation: "",
                     additionalInfo: "",
                     userResponseFeedback: ""
                 };
                 let currentSection = 'explanation';

                 for (const line of lines) {
                     const trimmedLine = line.trim();
                     if (!trimmedLine) continue; // ç©ºè¡Œã¯ç„¡è¦–

                     if (trimmedLine.startsWith("åˆ¤å®š:")) {
                         const judgementText = trimmedLine.substring(3).trim();
                         if (judgementText.includes("æ­£è§£")) result.judgement = "æ­£è§£";
                         else if (judgementText.includes("ä¸æ­£è§£")) result.judgement = "ä¸æ­£è§£";
                         currentSection = 'explanation'; // åˆ¤å®šã®å¾Œã¯èª¬æ˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨ã¿ãªã™
                     } else if (trimmedLine.startsWith("èª¬æ˜:")) {
                         result.explanation += trimmedLine.substring(3).trim() + "\n";
                         currentSection = 'explanation';
                     } else if (trimmedLine.startsWith("è¿½åŠ å›ç­”ã«ã¤ã„ã¦:") || trimmedLine.startsWith("ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ç­”ã«ã¤ã„ã¦:")) {
                         result.userResponseFeedback += trimmedLine.substring(trimmedLine.indexOf(':') + 1).trim() + "\n";
                         currentSection = 'userResponseFeedback';
                     } else if (trimmedLine.startsWith("è¿½åŠ æƒ…å ±:") || trimmedLine.startsWith("é–¢é€£æƒ…å ±:")) {
                         result.additionalInfo += trimmedLine.substring(trimmedLine.indexOf(':') + 1).trim() + "\n";
                         currentSection = 'additionalInfo';
                     } else {
                         // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ãŒãªã„å ´åˆã¯ã€å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
                         switch(currentSection) {
                             case 'explanation': result.explanation += trimmedLine + "\n"; break;
                             case 'userResponseFeedback': result.userResponseFeedback += trimmedLine + "\n"; break;
                             case 'additionalInfo': result.additionalInfo += trimmedLine + "\n"; break;
                             default: result.explanation += trimmedLine + "\n"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯èª¬æ˜
                         }
                     }
                 }
                 // æœ«å°¾ã®æ”¹è¡Œã‚’å‰Šé™¤
                 result.explanation = result.explanation.trim();
                 result.additionalInfo = result.additionalInfo.trim();
                 result.userResponseFeedback = result.userResponseFeedback.trim();
                // console.log("Parsed Evaluation:", result); // ãƒ‡ãƒãƒƒã‚°ç”¨
                 return result;
             }

            // APIå‘¼ã³å‡ºã—å…±é€šé–¢æ•°
            async function callOllamaAPI(endpoint, prompt, abortSignal) {
                console.log("Calling API:", endpoint); // ãƒ‡ãƒãƒƒã‚°ç”¨
                // console.log("Prompt:", prompt); // å¿…è¦ã«å¿œã˜ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚‚ãƒ­ã‚°å‡ºåŠ›
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: OLLAMA_MODEL,
                            prompt: prompt,
                            stream: false // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãªã—
                        }),
                        signal: abortSignal // AbortControllerã®ã‚·ã‚°ãƒŠãƒ«
                    });

                    if (!response.ok) {
                        let errorBody = 'å¿œç­”ãƒœãƒ‡ã‚£ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                        try {
                            errorBody = await response.text();
                        } catch (e) { console.error("Error reading error response body:", e); }
                        console.error("API Error Response:", response.status, response.statusText, errorBody);
                        throw new Error(`APIã‚¨ãƒ©ãƒ¼ (${response.status}): ${response.statusText}. ${errorBody}`);
                    }

                    const data = await response.json();
                    // console.log("API Response Data:", data); // ãƒ‡ãƒãƒƒã‚°ç”¨
                    if (data && data.response) {
                        return data.response;
                    } else {
                        throw new Error("APIå¿œç­”ã®å½¢å¼ãŒä¸æ­£ã§ã™ (responseãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“)ã€‚");
                    }

                } catch (error) {
                     if (error.name === 'AbortError') {
                         console.log('APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚');
                         // AbortErrorã¯å‘¼ã³å‡ºã—å…ƒã§å‡¦ç†ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯å†ã‚¹ãƒ­ãƒ¼ã—ãªã„ã‹ã€ç‰¹å®šã®æƒ…å ±ã‚’è¿”ã™
                         throw error; // å†ã‚¹ãƒ­ãƒ¼ã—ã¦å‘¼ã³å‡ºã—å…ƒã§åˆ¤å®š
                     }
                     console.error("APIå‘¼ã³å‡ºã—ä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼:", error);
                     // fetch ìì²´ì˜ ì—ëŸ¬ (ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ë“±)
                     throw new Error(`APIé€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                }
            }

            // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---

            // å•é¡Œç”Ÿæˆå‡¦ç†
            async function handleGenerateQuestion() {
                // æ—¢å­˜ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ã‚Œã°ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                appState.generateAbortController?.abort();
                appState.generateAbortController = new AbortController();

                const difficulty = difficultySelect.value;
                const systemPrompt = systemPromptTextarea.value;
                const knowledge = knowledgeInput.value;

                if (!knowledge.trim()) {
                    alert("çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                    knowledgeInput.focus();
                    return;
                }

                updateUIState('generating');
                resetQuizUI();

                const combinedPrompt = `${systemPrompt}\n\nçŸ¥è­˜ãƒ™ãƒ¼ã‚¹:\n${knowledge}\n\né›£æ˜“åº¦: ${difficulty}`;
                let rawResponse = ''; // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºç”¨ã«ä¿æŒ

                try {
                    // APIå‘¼ã³å‡ºã—ã¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
                    const apiPromise = callOllamaAPI(
                        API_ENDPOINTS.generate,
                        combinedPrompt,
                        appState.generateAbortController.signal
                    );
                    const timeoutPromise = new Promise((_, reject) =>
                         setTimeout(() => reject(new Error(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ (${API_TIMEOUT / 1000}ç§’)`)), API_TIMEOUT)
                    );

                    rawResponse = await Promise.race([apiPromise, timeoutPromise]);

                    const parsedData = parseQuestionResponse(rawResponse);

                    // ã‚¯ã‚¤ã‚ºçŠ¶æ…‹æ›´æ–°
                    appState.currentQuiz = parsedData;
                    appState.userSelection = null; // é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ

                    // UIæ›´æ–°
                    questionText.textContent = parsedData.question;
                    optionTexts.A.textContent = parsedData.options.A;
                    optionTexts.B.textContent = parsedData.options.B;
                    optionTexts.C.textContent = parsedData.options.C;
                    optionTexts.D.textContent = parsedData.options.D;

                    updateUIState('generated');

                } catch (error) {
                     console.error("å•é¡Œç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
                     if (error.name !== 'AbortError') { // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä»¥å¤–ã®ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
                         generateErrorDetails.textContent = `${error.message}\n\n--- å—ä¿¡ã—ãŸå¿œç­” (ä¸€éƒ¨) ---\n${rawResponse.substring(0, 200)}${rawResponse.length > 200 ? '...' : ''}`; // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨å¿œç­”ã®ä¸€éƒ¨ã‚’è¡¨ç¤º
                         updateUIState('error_generate');
                     } else {
                         // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆã¯åˆæœŸçŠ¶æ…‹ã«æˆ»ã™ãªã©æ¤œè¨
                          updateUIState('initial'); // ã¾ãŸã¯ generating ã®ã¾ã¾ã«ã™ã‚‹ã‹
                     }
                } finally {
                     // AbortControllerã‚’ã‚¯ãƒªã‚¢
                     appState.generateAbortController = null;
                }
            }

            // å›ç­”è©•ä¾¡å‡¦ç†
            async function handleEvaluateAnswer() {
                appState.evaluateAbortController?.abort();
                appState.evaluateAbortController = new AbortController();

                if (!appState.userSelection) {
                    alert("é¸æŠè‚¢ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
                    return;
                }
                const userFreeText = userInput.value.trim();

                updateUIState('submitting');
                feedbackContainer.classList.remove('visible', 'feedback-correct', 'feedback-incorrect');
                let rawResponse = '';

                // è©•ä¾¡ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç”Ÿæˆ
                const evaluationPrompt = `
ã‚ãªãŸã¯æ•™è‚²ç›®çš„ã®ã‚¯ã‚¤ã‚ºè©•ä¾¡AIã§ã™ã€‚å…¬å¹³ã‹ã¤å®¢è¦³çš„ã«è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®æƒ…å ±ã«åŸºã¥ã„ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã‚’è©•ä¾¡ã—ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã—ã¦ãã ã•ã„ï¼š

**å•é¡Œ:** ${appState.currentQuiz.question}
**é¸æŠè‚¢:**
A: ${appState.currentQuiz.options.A}
B: ${appState.currentQuiz.options.B}
C: ${appState.currentQuiz.options.C}
D: ${appState.currentQuiz.options.D}
**æ­£è§£:** ${appState.currentQuiz.correctAnswer}
**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠ:** ${appState.userSelection} (${appState.currentQuiz.options[appState.userSelection]})
**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¿½åŠ å›ç­”/è³ªå•:** ${userFreeText || "ãªã—"}

**æŒ‡ç¤º:**
1. ã¾ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠãŒæ­£è§£ã‹ä¸æ­£è§£ã‹ã‚’æ˜ç¢ºã«åˆ¤å®šã—ã¦ãã ã•ã„ã€‚å‡ºåŠ›ã¯ã€Œåˆ¤å®š: æ­£è§£ã€ã¾ãŸã¯ã€Œåˆ¤å®š: ä¸æ­£è§£ã€ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„ã€‚
2. æ¬¡ã«ã€åˆ¤å®šã®æ ¹æ‹ ã¨ãªã‚‹ç°¡æ½”ãªèª¬æ˜ã‚’ã—ã¦ãã ã•ã„ã€‚ã€Œèª¬æ˜: ã€ã§å§‹ã‚ã¦ãã ã•ã„ã€‚æ­£è§£ã®é¸æŠè‚¢ (ä¾‹: C) ã¨ãã®å†…å®¹ã‚‚æ˜ç¢ºã«ç¤ºã—ã¦ãã ã•ã„ã€‚
3. ã‚‚ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¿½åŠ ã®å›ç­”ã‚„è³ªå•ã‚’è¨˜è¿°ã—ã¦ã„ãŸå ´åˆã¯ã€ãã‚Œã«å¯¾ã—ã¦å»ºè¨­çš„ã‹ã¤ä¸å¯§ã«å¿œç­”ã—ã¦ãã ã•ã„ã€‚ã€Œè¿½åŠ å›ç­”ã«ã¤ã„ã¦: ã€ã§å§‹ã‚ã¦ãã ã•ã„ã€‚è¨˜è¿°ãŒãªã„å ´åˆã¯ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ä¸è¦ã§ã™ã€‚
4. æœ€å¾Œã«ã€å­¦ç¿’ã«å½¹ç«‹ã¤å¯èƒ½æ€§ã®ã‚ã‚‹è¿½åŠ æƒ…å ±ã‚„é–¢é€£çŸ¥è­˜ãŒã‚ã‚Œã°æä¾›ã—ã¦ãã ã•ã„ã€‚ã€Œè¿½åŠ æƒ…å ±: ã€ã§å§‹ã‚ã¦ãã ã•ã„ã€‚å¿…é ˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
5. å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆåˆ¤å®šã€èª¬æ˜ã€è¿½åŠ å›ç­”ã«ã¤ã„ã¦ã€è¿½åŠ æƒ…å ±ï¼‰ã¯æ”¹è¡Œã§åŒºåˆ‡ã£ã¦ãã ã•ã„ã€‚

**å‡ºåŠ›ä¾‹ (æ­£è§£ã®å ´åˆ):**
åˆ¤å®š: æ­£è§£
èª¬æ˜: ãã®é€šã‚Šã§ã™ï¼æ­£è§£ã¯ ${appState.currentQuiz.correctAnswer} (${appState.currentQuiz.options[appState.currentQuiz.correctAnswer]}) ã§ã™ã€‚æœ¨æ˜Ÿã¯å¤ªé™½ç³»ã§æœ€å¤§ã®æƒ‘æ˜Ÿã§ã™ã€‚
è¿½åŠ å›ç­”ã«ã¤ã„ã¦: ã”æŒ‡æ‘˜ã®é€šã‚Šã€æœ¨æ˜Ÿã®å¤§èµ¤æ–‘ã¯å·¨å¤§ãªåµã§ã™ã­ã€‚ç´ æ™´ã‚‰ã—ã„çŸ¥è­˜ã§ã™ï¼
è¿½åŠ æƒ…å ±: æœ¨æ˜Ÿã¯ã‚¬ãƒªãƒ¬ã‚ªãƒ»ã‚¬ãƒªãƒ¬ã‚¤ã«ã‚ˆã£ã¦ç™ºè¦‹ã•ã‚ŒãŸ4ã¤ã®å¤§ããªè¡›æ˜Ÿï¼ˆã‚¬ãƒªãƒ¬ã‚ªè¡›æ˜Ÿï¼‰ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

**å‡ºåŠ›ä¾‹ (ä¸æ­£è§£ã®å ´åˆ):**
åˆ¤å®š: ä¸æ­£è§£
èª¬æ˜: æ®‹å¿µï¼æ­£è§£ã¯ ${appState.currentQuiz.correctAnswer} (${appState.currentQuiz.options[appState.currentQuiz.correctAnswer]}) ã§ã™ã€‚æœ¨æ˜ŸãŒå¤ªé™½ç³»ã§æœ€å¤§ã®æƒ‘æ˜Ÿã§ã™ã€‚ã‚ãªãŸãŒé¸æŠã—ãŸ ${appState.userSelection} (${appState.currentQuiz.options[appState.userSelection]}) ã¯ã€[ä¸æ­£è§£ã®ç†ç”±ã‚„ç‰¹å¾´ãªã©]ã€‚
è¿½åŠ æƒ…å ±: åœŸæ˜Ÿã¯ãã®ç¾ã—ã„ç’°ã§æœ‰åã§ã™ãŒã€å¤§ãã•ã§ã¯æœ¨æ˜Ÿã«æ¬¡ã„ã§2ç•ªç›®ã§ã™ã€‚
`;

                try {
                    const apiPromise = callOllamaAPI(
                        API_ENDPOINTS.evaluate,
                        evaluationPrompt,
                        appState.evaluateAbortController.signal
                    );
                    const timeoutPromise = new Promise((_, reject) =>
                         setTimeout(() => reject(new Error(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ (${API_TIMEOUT / 1000}ç§’)`)), API_TIMEOUT)
                    );

                    rawResponse = await Promise.race([apiPromise, timeoutPromise]);
                    const parsedFeedback = parseEvaluationResponse(rawResponse);
                    const isCorrect = parsedFeedback.judgement === "æ­£è§£";

                    // UIæ›´æ–°
                    feedbackContainer.className = "feedback-container visible " + (isCorrect ? "feedback-correct" : "feedback-incorrect");
                    feedbackHeader.textContent = isCorrect ? "ğŸ‰ æ­£è§£ã§ã™ï¼" : "ğŸ¤” ä¸æ­£è§£ã§ã™";

                    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å†…å®¹ã‚’HTMLå½¢å¼ã§æ•´å½¢ã—ã¦è¡¨ç¤º
                    let feedbackHTML = `<div class="explanation"><strong>èª¬æ˜:</strong><br>${sanitizeText(parsedFeedback.explanation)}</div>`;
                    if (parsedFeedback.userResponseFeedback) {
                        feedbackHTML += `<div class="user-response"><h4>ã‚ãªãŸã®è¿½åŠ å›ç­”/è³ªå•ã«ã¤ã„ã¦:</h4><p>${sanitizeText(parsedFeedback.userResponseFeedback)}</p></div>`;
                    }
                    if (parsedFeedback.additionalInfo) {
                        feedbackHTML += `<div class="additional-resources"><h4>è¿½åŠ æƒ…å ±:</h4><p>${sanitizeText(parsedFeedback.additionalInfo)}</p></div>`;
                    }
                    safeRenderHTML(feedbackContent, feedbackHTML);

                    updateUIState('submitted');

                } catch (error) {
                     console.error("å›ç­”è©•ä¾¡ã‚¨ãƒ©ãƒ¼:", error);
                     if (error.name !== 'AbortError') {
                         submitErrorDetails.textContent = `${error.message}\n\n--- å—ä¿¡ã—ãŸå¿œç­” (ä¸€éƒ¨) ---\n${rawResponse.substring(0, 200)}${rawResponse.length > 200 ? '...' : ''}`;
                         updateUIState('error_submit');
                     } else {
                         updateUIState('generated'); // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‚‰å›ç­”å¯èƒ½ãªçŠ¶æ…‹ã«æˆ»ã™
                     }
                } finally {
                    appState.evaluateAbortController = null;
                }
            }

            // æ¬¡ã®å•é¡Œã¸
            function handleNextQuestion() {
                 // çŠ¶æ…‹ã‚’åˆæœŸåŒ–
                 appState.currentQuiz = { question: "", options: {}, correctAnswer: "" };
                 appState.userSelection = null;
                 userInput.value = '';
                 resetQuizUI();
                 updateUIState('initial');
                 // è¨­å®šãƒ‘ãƒãƒ«ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã€ç”Ÿæˆãƒœã‚¿ãƒ³ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                 settingsPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                 generateBtn.focus();
            }

             // é¸æŠè‚¢ã®é¸æŠãƒãƒ³ãƒ‰ãƒ© (Event Delegation)
             function handleOptionSelect(event) {
                 // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³è‡ªèº«ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‹¾ã†
                 if (event.target.type === 'radio' && event.target.name === 'quizOption') {
                     const selectedValue = event.target.value;
                     appState.userSelection = selectedValue;

                     // UIæ›´æ–°ï¼ˆé¸æŠçŠ¶æ…‹ã®å¼·èª¿è¡¨ç¤ºï¼‰
                     Object.values(optionLabels).forEach(label => {
                         label.classList.remove('selected');
                     });
                     if (optionLabels[selectedValue]) {
                         optionLabels[selectedValue].classList.add('selected');
                     }
                     // é€ä¿¡ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
                      updateUIState(appState.status); // statusè‡ªä½“ã¯å¤‰ãˆãšã€ãƒœã‚¿ãƒ³çŠ¶æ…‹ã ã‘æ›´æ–°
                 }
             }

            // --- UIãƒªã‚»ãƒƒãƒˆé–¢æ•° ---
            function resetQuizUI() {
                questionText.textContent = ''; // ç©ºã«ã™ã‚‹
                Object.values(optionTexts).forEach(el => el.textContent = '');
                radioInputs.forEach(input => {
                     input.checked = false;
                     input.disabled = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç„¡åŠ¹
                 });
                Object.values(optionLabels).forEach(label => {
                     label.classList.remove('selected');
                     label.style.cursor = 'default';
                     label.style.opacity = '0.7';
                 });
                feedbackContainer.classList.remove('visible', 'feedback-correct', 'feedback-incorrect');
                feedbackContent.innerHTML = '';
                // userInput.value = ''; // å¿…è¦ã«å¿œã˜ã¦ã‚¯ãƒªã‚¢
            }

            // --- åˆæœŸåŒ– ---
            function init() {
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                generateBtn.addEventListener('click', handleGenerateQuestion);
                submitBtn.addEventListener('click', handleEvaluateAnswer);
                nextQuestionBtn.addEventListener('click', handleNextQuestion);
                 // é¸æŠè‚¢ã‚°ãƒ«ãƒ¼ãƒ—ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (changeã‚¤ãƒ™ãƒ³ãƒˆã§ååˆ†)
                 if (optionGroup) {
                     optionGroup.addEventListener('change', handleOptionSelect);
                 } else { console.error("Element .option-group not found."); }

                // åˆæœŸçŠ¶æ…‹è¨­å®š
                resetQuizUI(); // ã¾ãšUIã‚’ãƒªã‚»ãƒƒãƒˆ
                updateUIState('initial'); // åˆæœŸçŠ¶æ…‹ã«è¨­å®š
            }

            // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ ---
            init();
        });
    </script>
</body>
</html>