<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SmartQ - Ollamaを活用したAIクイズアプリ">
    <title>SmartQ - インテリジェントなクイズアプリケーション</title>
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-hover: #3a56d4;
            --secondary-color: #f8f9fa;
            --accent-color: #4cc9f0;
            --text-color: #333;
            --light-text: #6c757d;
            --border-color: #e2e8f0;
            --success-color: #4caf50;
            --error-color: #f44336;
            --warning-color: #ff9800;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
             height: 100%; /* html要素の高さを100%に */
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f5f7fa;
            padding: 20px;
            display: flex; /* Flexboxをbodyに適用 */
            flex-direction: column; /* 子要素を縦方向に並べる */
            min-height: 100%; /* bodyの高さを最低でもビューポートの高さに */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%; /* コンテナ幅を100%に */
            flex: 1; /* 利用可能なスペースを埋める */
            display: flex; /* Flexboxをcontainerに適用 */
            flex-direction: column; /* container内の要素も縦に */
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            flex-shrink: 0; /* ヘッダーが縮まないように */
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .tagline {
            font-size: 1.2rem;
            color: var(--light-text);
            margin-bottom: 20px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 30px;
            flex-grow: 1; /* メインコンテンツが利用可能なスペースを埋める */
            margin-bottom: 30px;
        }

        .panel {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            padding: 25px;
            transition: var(--transition);
            display: flex; /* パネル内でFlexboxを使用 */
            flex-direction: column; /* パネル内の要素を縦方向に配置 */
        }

        .panel-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            flex-shrink: 0; /* タイトルが縮まないように */
        }

        .form-group {
            margin-bottom: 20px;
        }
        /* 知識ベースのテキストエリアを含むフォームグループが伸びるように */
        .form-group.flex-grow {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .form-group.flex-grow textarea {
             flex-grow: 1; /* テキストエリア自体も伸びるように */
             min-height: 150px; /* 最小高さを確保 */
        }


        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        /* input[type="text"] などの具体的な指定 */
        select, textarea, button, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
            transition: var(--transition);
        }

        select {
            appearance: none; /* OS標準のスタイルを無効化 */
            background-color: white;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill="%23333" d="M8 11.414l-4.707-4.707a1 1 0 0 1 1.414-1.414L8 8.586l3.293-3.293a1 1 0 1 1 1.414 1.414L8 11.414z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px; /* アイコンのスペース */
            cursor: pointer;
        }

        select:hover, textarea:hover, input[type="text"]:hover {
            border-color: var(--primary-color);
        }

        select:focus, textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        #systemPrompt {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        #knowledgeInput {
            /* min-heightは.form-group.flex-grow textareaで設定 */
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            border: none;
            padding: 14px;
            margin-top: 10px;
            transition: var(--transition);
        }

        /* :disabledでない時のみhover/active効果を適用 */
        button:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            background-color: var(--light-text);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7; /* 無効状態を視覚的に示す */
        }

        .question-display {
            background-color: var(--secondary-color);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            border-left: 4px solid var(--primary-color);
            line-height: 1.7; /* 問題文の行間調整 */
        }

        .option-group {
            margin-bottom: 25px;
            border: none; /* fieldsetのデフォルトボーダーを消す */
            padding: 0; /* fieldsetのデフォルトパディングを消す */
        }

        /* label要素に変更 */
        .option-label {
            display: flex;
            align-items: flex-start; /* テキストが複数行になってもradioが上部に揃う */
            margin-bottom: 12px;
            padding: 15px;
            background-color: white; /* 背景を白に変更 */
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            transition: var(--transition);
            cursor: pointer;
        }

        .option-label:hover {
            background-color: #e9ecef;
            border-color: var(--primary-color);
        }

        /* 選択されているラベルのスタイル */
        .option-label.selected {
            background-color: #e8f0fe;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2); /* 選択をより明確に */
        }
        /* チェックされたラジオボタンに続くテキストを太字に */
        input[type="radio"]:checked + .option-text {
             font-weight: 600;
        }


        .option-radio {
            margin-right: 15px;
            margin-top: 3px; /* 微調整 */
            width: 18px; /* サイズ調整 */
            height: 18px;
            flex-shrink: 0; /* labelリサイズ時に縮まないように */
            cursor: pointer;
            accent-color: var(--primary-color); /* 対応ブラウザでラジオボタンの色を変更 */
        }

        .option-text {
            flex: 1;
        }

        .feedback-container {
            margin-top: 25px;
            padding: 20px;
            border-radius: var(--border-radius);
            background-color: #f8f9fa;
            display: none; /* 初期状態非表示 */
            opacity: 0;
            transition: opacity 0.5s ease;
            overflow: hidden;
        }

        .feedback-container.visible {
            display: block;
            opacity: 1;
            animation: fadeIn 0.5s ease-out; /* fadeInアニメーション適用 */
        }

        .feedback-header {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--text-color);
            font-weight: 600;
        }

        .feedback-content {
            line-height: 1.7;
        }

        .feedback-correct {
            border-left: 4px solid var(--success-color);
            background-color: #e8f5e9; /* 正解時の背景色 */
        }

        .feedback-incorrect {
            border-left: 4px solid var(--error-color);
            background-color: #ffebee; /* 不正解時の背景色 */
        }

        .section-header { /* legendなど */
            font-size: 1.2rem;
            margin: 15px 0 8px 0;
            color: var(--text-color);
            font-weight: 600; /* 少し強調 */
        }

        /* フィードバック内の各セクション */
        .explanation, .user-response, .additional-resources {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px; /* セクション間のマージン */
            background-color: white; /* デフォルト背景を白に */
        }
        .explanation strong { /* 説明の強調部分 */
            color: var(--primary-color);
            font-weight: 600;
        }
        .explanation {
             border-left: 3px solid var(--primary-color);
        }

        .user-response {
            background-color: #f0f7ff;
            border-left: 3px solid var(--accent-color);
        }
        .user-response h4 {
            margin: 0 0 8px 0;
            color: var(--accent-color);
            font-size: 1rem;
        }

        .additional-resources {
            background-color: #f0fdf4;
            border-left: 3px solid var(--success-color);
        }
        .additional-resources h4 {
            margin: 0 0 8px 0;
            color: var(--success-color);
            font-size: 1rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px 0; /* 上下のパディングのみ */
            color: var(--light-text);
        }

        .loading.visible {
            display: block;
        }

        .loading .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 10px;
        }
        .loading p {
            font-size: 0.9rem;
            margin: 0;
        }

        .error-message {
            background-color: #ffebee;
            color: var(--error-color);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            border-left: 3px solid var(--error-color);
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .error-message.visible {
            display: block;
            opacity: 1;
            animation: fadeIn 0.3s ease-out;
        }
        .error-message p {
            margin: 0;
            line-height: 1.5;
        }
        .error-message strong { /* エラータイトル */
             display: block;
             margin-bottom: 5px;
             font-weight: 600;
        }
        .error-message code { /* エラー詳細用 */
            font-size: 0.85rem;
            background-color: rgba(0,0,0,0.05);
            padding: 2px 4px;
            border-radius: 3px;
            word-break: break-all; /* 長いエラーメッセージを折り返す */
        }

        .button-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-shrink: 0; /* ボタンコンテナが縮まないように */
        }

        .button-container button {
            flex: 1; /* ボタン幅を均等に */
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-bottom: 20px;
            color: var(--light-text);
            font-size: 0.9rem;
            flex-shrink: 0; /* フッターが縮まないように */
        }

        /* レスポンシブデザイン */
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr; /* 1カラムレイアウトに */
            }
            h1 {
                font-size: 2rem;
            }
            .panel {
                padding: 20px;
            }
        }

        @media (max-width: 600px) { /* 中間ブレークポイント */
             body {
                 padding: 15px;
             }
             .panel {
                 padding: 15px;
             }
              #systemPrompt { min-height: 150px; }
        }


        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            h1 {
                font-size: 1.8rem;
            }
            .option-label {
                padding: 12px;
            }
            .option-radio {
                margin-right: 10px;
            }
            .tagline {
                font-size: 1rem;
            }
             /* スマホではボタンを縦積みに */
             .button-container {
                 flex-direction: column;
             }
             .button-container button {
                  width: 100%; /* 幅を100%に */
             }
        }

        /* アニメーション */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SmartQ</h1>
            <p class="tagline">AIが生成するクイズで知識の幅を広げよう</p>
        </header>

        <main class="main-content">
            <!-- 左側パネル - 設定 -->
            <section class="panel" id="settingsPanel" aria-labelledby="settingsTitle">
                <h2 class="panel-title" id="settingsTitle">設定</h2>

                <div class="form-group">
                    <label for="difficulty">難易度</label>
                    <select id="difficulty" aria-label="クイズの難易度">
                        <option value="easy">初級</option>
                        <option value="medium" selected>中級</option>
                        <option value="hard">上級</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="systemPrompt">システムプロンプト (AIへの指示)</label>
                    <textarea id="systemPrompt" aria-label="AIへの指示">あなたは教育目的のクイズ作成AIです。
以下の条件で問題を生成してください：
1. 提供された知識をベースに関連する問題を1つ作成する
2. 問題は明確で理解しやすいものにする
3. 4つの選択肢を提供する（1つの正解と3つの誤答）
4. 選択肢はA, B, C, Dでラベル付けする
5. 正解の選択肢を明示的にマークする

出力形式（以下の形式を厳守してください）：
問題: [問題文]
A: [選択肢A]
B: [選択肢B]
C: [選択肢C]
D: [選択肢D]
正解: [正解の選択肢のラベル (A, B, C, D のいずれか1文字)]</textarea>
                </div>

                <!-- flex-grow クラスを追加して高さを可変に -->
                <div class="form-group flex-grow">
                    <label for="knowledgeInput">知識ベース（問題の元となる情報を入力）</label>
                    <textarea id="knowledgeInput" aria-label="問題の元となる知識や情報" placeholder="ここに知識や情報を入力すると、それに基づいた問題が生成されます。テキスト、文章、事実など自由に入力できます。"></textarea>
                </div>

                <div class="button-container">
                    <button id="generateBtn" aria-label="問題を生成する">問題を生成する</button>
                </div>

                <div class="loading" id="loadingGenerate" role="status" aria-live="polite">
                    <div class="spinner" aria-hidden="true"></div>
                    <p>問題を生成しています...</p>
                </div>

                <div class="error-message" id="generateError" role="alert" aria-live="assertive">
                    <p><strong>エラー</strong> 問題の生成中に問題が発生しました。</p>
                    <p><code id="generateErrorDetails"></code></p>
                </div>
            </section>

            <!-- 右側パネル - クイズと回答 -->
            <section class="panel" id="quizPanel" aria-labelledby="quizTitle">
                <h2 class="panel-title" id="quizTitle">クイズ</h2>

                <div id="quizContainer" style="display: none;">
                    <div class="question-display" aria-live="polite">
                        <p id="questionText"></p>
                    </div>

                    <!-- fieldset と legend を使用 -->
                    <fieldset class="option-group" role="radiogroup" aria-labelledby="optionsLabel">
                        <legend id="optionsLabel" class="section-header">選択肢</legend>

                        <!-- label要素でラップし、for属性で関連付け -->
                        <label class="option-label" id="optionAContainer" for="radioA">
                            <input type="radio" name="quizOption" id="radioA" class="option-radio" value="A" aria-labelledby="optionAText">
                            <span class="option-text" id="optionAText">選択肢 A</span>
                        </label>

                        <label class="option-label" id="optionBContainer" for="radioB">
                            <input type="radio" name="quizOption" id="radioB" class="option-radio" value="B" aria-labelledby="optionBText">
                            <span class="option-text" id="optionBText">選択肢 B</span>
                        </label>

                        <label class="option-label" id="optionCContainer" for="radioC">
                            <input type="radio" name="quizOption" id="radioC" class="option-radio" value="C" aria-labelledby="optionCText">
                            <span class="option-text" id="optionCText">選択肢 C</span>
                        </label>

                        <label class="option-label" id="optionDContainer" for="radioD">
                            <input type="radio" name="quizOption" id="radioD" class="option-radio" value="D" aria-labelledby="optionDText">
                            <span class="option-text" id="optionDText">選択肢 D</span>
                        </label>
                    </fieldset>

                    <div class="form-group">
                        <label for="userInput">追加回答/質問 (オプション)</label>
                        <textarea id="userInput" placeholder="回答に対する補足や質問があれば入力してください" aria-label="追加の回答や質問"></textarea>
                    </div>

                    <div class="button-container">
                        <button id="submitBtn" aria-label="回答を送信する">回答を送信する</button>
                        <button id="nextQuestionBtn" aria-label="次の問題へ">次の問題へ</button>
                    </div>

                    <div class="loading" id="loadingSubmit" role="status" aria-live="polite">
                        <div class="spinner" aria-hidden="true"></div>
                        <p>回答を評価しています...</p>
                    </div>

                    <div class="error-message" id="submitError" role="alert" aria-live="assertive">
                        <p><strong>エラー</strong> 回答の評価中に問題が発生しました。</p>
                        <p><code id="submitErrorDetails"></code></p>
                    </div>

                    <div class="feedback-container" id="feedbackContainer" aria-live="polite">
                        <h3 class="feedback-header" id="feedbackHeader">フィードバック</h3>
                        <div class="feedback-content" id="feedbackContent"></div>
                    </div>
                </div>

                <!-- 初期メッセージ -->
                <div id="initialMessage" style="text-align: center; padding: 40px 20px; flex-grow: 1; display: flex; align-items: center; justify-content: center;">
                    <p style="color: var(--light-text);">左側のパネルから問題の設定と知識ベースを入力し、「問題を生成する」ボタンをクリックしてください。</p>
                </div>
            </section>
        </main>

        <footer>
            <p>© 2025 SmartQ - スマートにクイズで学ぶ、新しい学習体験。</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- 定数定義 ---
            const API_ENDPOINTS = {
                // ローカルOllama APIのエンドポイント (環境に合わせて変更)
                // generate: '/api/proxy/generate', // 例: バックエンドプロキシ経由
                // evaluate: '/api/proxy/evaluate', // 例: バックエンドプロキシ経由
                generate: 'http://localhost:11434/api/generate', // 直接接続 (CORS設定注意)
                evaluate: 'http://localhost:11434/api/generate' // 直接接続 (CORS設定注意)
            };
            const OLLAMA_MODEL = 'llama3'; // 使用するOllamaモデル名
            const API_TIMEOUT = 30000; // APIリクエストのタイムアウト時間 (ミリ秒)

            // --- DOM要素の参照 ---
            const settingsPanel = document.getElementById('settingsPanel');
            const difficultySelect = document.getElementById('difficulty');
            const systemPromptTextarea = document.getElementById('systemPrompt');
            const knowledgeInput = document.getElementById('knowledgeInput');
            const generateBtn = document.getElementById('generateBtn');
            const submitBtn = document.getElementById('submitBtn');
            const nextQuestionBtn = document.getElementById('nextQuestionBtn');
            const questionText = document.getElementById('questionText');
            const optionLabels = { // label要素を参照
                A: document.getElementById('optionAContainer'),
                B: document.getElementById('optionBContainer'),
                C: document.getElementById('optionCContainer'),
                D: document.getElementById('optionDContainer')
            };
            const optionTexts = { // span要素を参照
                A: document.getElementById('optionAText'),
                B: document.getElementById('optionBText'),
                C: document.getElementById('optionCText'),
                D: document.getElementById('optionDText')
            };
            const radioInputs = document.querySelectorAll('.option-radio');
            const userInput = document.getElementById('userInput');
            const quizContainer = document.getElementById('quizContainer');
            const initialMessage = document.getElementById('initialMessage');
            const loadingGenerate = document.getElementById('loadingGenerate');
            const loadingSubmit = document.getElementById('loadingSubmit');
            const generateError = document.getElementById('generateError');
            const generateErrorDetails = document.getElementById('generateErrorDetails');
            const submitError = document.getElementById('submitError');
            const submitErrorDetails = document.getElementById('submitErrorDetails');
            const feedbackContainer = document.getElementById('feedbackContainer');
            const feedbackHeader = document.getElementById('feedbackHeader');
            const feedbackContent = document.getElementById('feedbackContent');
            const optionGroup = document.querySelector('.option-group'); // fieldset

            // --- 状態管理 ---
            const appState = {
                currentQuiz: { question: "", options: {}, correctAnswer: "" },
                userSelection: null,
                status: 'initial', // 'initial', 'generating', 'generated', 'submitting', 'submitted', 'error_generate', 'error_submit'
                generateAbortController: null, // 問題生成用AbortController
                evaluateAbortController: null, // 評価用AbortController
            };

            // --- UI更新関数 ---
            function updateUIState(newState) {
                const previousState = appState.status;
                appState.status = newState;
                console.log(`State changed: ${previousState} -> ${newState}`); // デバッグ用ログ

                // ローディング表示
                loadingGenerate.classList.toggle('visible', newState === 'generating');
                loadingSubmit.classList.toggle('visible', newState === 'submitting');

                // エラー表示リセット
                generateError.classList.remove('visible');
                submitError.classList.remove('visible');
                generateErrorDetails.textContent = ''; // エラー詳細もクリア
                submitErrorDetails.textContent = '';

                // ボタンの有効/無効
                generateBtn.disabled = newState === 'generating' || newState === 'submitting';
                submitBtn.disabled = !(newState === 'generated' && appState.userSelection !== null); // 生成済みかつ選択肢が選ばれている場合のみ有効
                nextQuestionBtn.disabled = newState !== 'submitted';

                // パネル表示制御
                 quizContainer.style.display = (newState !== 'initial' && newState !== 'generating' && newState !== 'error_generate') ? 'block' : 'none';
                 initialMessage.style.display = (newState === 'initial' || newState === 'generating' || newState === 'error_generate') ? 'flex' : 'none'; // 初期メッセージはflexで中央揃え

                // フィードバック表示
                feedbackContainer.classList.toggle('visible', newState === 'submitted');

                // オプションの操作可否
                const isOptionsEnabled = newState === 'generated';
                radioInputs.forEach(input => input.disabled = !isOptionsEnabled);
                Object.values(optionLabels).forEach(label => {
                    label.style.cursor = isOptionsEnabled ? 'pointer' : 'default';
                    label.style.opacity = isOptionsEnabled ? '1' : '0.7';
                    if (!isOptionsEnabled) {
                         label.classList.remove('selected'); // 操作不可なら選択状態も解除
                    }
                });

                // エラー発生時の表示
                if (newState === 'error_generate') generateError.classList.add('visible');
                if (newState === 'error_submit') submitError.classList.add('visible');

                // 状態遷移に応じたフォーカス管理 (アクセシビリティ向上)
                if (newState === 'generated' && previousState !== 'generated') {
                     radioInputs[0]?.focus(); // 最初の選択肢にフォーカス
                 } else if (newState === 'submitted' && previousState !== 'submitted') {
                     nextQuestionBtn?.focus(); // 次の問題ボタンにフォーカス
                 } else if (newState === 'initial' && previousState !== 'initial') {
                     generateBtn?.focus(); // 初期状態に戻ったら生成ボタンにフォーカス
                 }
            }

            // --- ヘルパー関数 ---

            // テキストのサニタイズ（簡易版 - 表示用）
            function sanitizeText(text) {
                 if (typeof text !== 'string') return '';
                 const tempDiv = document.createElement('div');
                 tempDiv.textContent = text;
                 return tempDiv.innerHTML.replace(/\n/g, '<br>'); // 改行を<br>に変換
            }

            // 安全にHTMLをレンダリング (サニタイズ済みテキスト用)
            function safeRenderHTML(container, sanitizedHtmlString) {
                 // 注意: この関数は入力が既にサニタイズされていることを前提とします。
                 // DOMPurifyなどのライブラリを使うのが最も安全です。
                 container.innerHTML = sanitizedHtmlString;
            }

            // AI応答から問題情報をパース
             function parseQuestionResponse(response) {
                 const lines = response.trim().split('\n');
                 const result = { question: "", options: { A: "", B: "", C: "", D: "" }, correctAnswer: "" };
                 let currentOption = null;

                 for (const line of lines) {
                     const trimmedLine = line.trim();
                     if (trimmedLine.startsWith("問題:")) {
                         result.question = trimmedLine.substring(3).trim();
                     } else if (trimmedLine.match(/^([A-D]):/)) {
                         const key = RegExp.$1;
                         result.options[key] = trimmedLine.substring(2).trim();
                     } else if (trimmedLine.startsWith("正解:")) {
                         // 正解ラベル (A, B, C, D) のみ抽出
                         const match = trimmedLine.substring(3).trim().match(/^[A-D]/);
                         if (match) {
                             result.correctAnswer = match[0];
                         }
                     }
                 }
                // console.log("Parsed Question:", result); // デバッグ用

                 // 必須項目チェック
                 if (!result.question || !result.options.A || !result.options.B || !result.options.C || !result.options.D || !['A', 'B', 'C', 'D'].includes(result.correctAnswer)) {
                     console.error("パースエラー: 必須情報が不足しています。", result, "元レスポンス: ", response);
                     throw new Error("AIの応答形式が不正です。問題、選択肢A〜D、正解(A/B/C/D)を正しく抽出できませんでした。");
                 }
                 return result;
             }

             // AI応答から評価情報をパース（より柔軟に）
             function parseEvaluationResponse(response) {
                 const lines = response.trim().split('\n');
                 const result = {
                     judgement: "不明", // '正解', '不正解', '不明'
                     explanation: "",
                     additionalInfo: "",
                     userResponseFeedback: ""
                 };
                 let currentSection = 'explanation';

                 for (const line of lines) {
                     const trimmedLine = line.trim();
                     if (!trimmedLine) continue; // 空行は無視

                     if (trimmedLine.startsWith("判定:")) {
                         const judgementText = trimmedLine.substring(3).trim();
                         if (judgementText.includes("正解")) result.judgement = "正解";
                         else if (judgementText.includes("不正解")) result.judgement = "不正解";
                         currentSection = 'explanation'; // 判定の後は説明セクションとみなす
                     } else if (trimmedLine.startsWith("説明:")) {
                         result.explanation += trimmedLine.substring(3).trim() + "\n";
                         currentSection = 'explanation';
                     } else if (trimmedLine.startsWith("追加回答について:") || trimmedLine.startsWith("ユーザー回答について:")) {
                         result.userResponseFeedback += trimmedLine.substring(trimmedLine.indexOf(':') + 1).trim() + "\n";
                         currentSection = 'userResponseFeedback';
                     } else if (trimmedLine.startsWith("追加情報:") || trimmedLine.startsWith("関連情報:")) {
                         result.additionalInfo += trimmedLine.substring(trimmedLine.indexOf(':') + 1).trim() + "\n";
                         currentSection = 'additionalInfo';
                     } else {
                         // セクションヘッダーがない場合は、前のセクションに追加
                         switch(currentSection) {
                             case 'explanation': result.explanation += trimmedLine + "\n"; break;
                             case 'userResponseFeedback': result.userResponseFeedback += trimmedLine + "\n"; break;
                             case 'additionalInfo': result.additionalInfo += trimmedLine + "\n"; break;
                             default: result.explanation += trimmedLine + "\n"; // デフォルトは説明
                         }
                     }
                 }
                 // 末尾の改行を削除
                 result.explanation = result.explanation.trim();
                 result.additionalInfo = result.additionalInfo.trim();
                 result.userResponseFeedback = result.userResponseFeedback.trim();
                // console.log("Parsed Evaluation:", result); // デバッグ用
                 return result;
             }

            // API呼び出し共通関数
            async function callOllamaAPI(endpoint, prompt, abortSignal) {
                console.log("Calling API:", endpoint); // デバッグ用
                // console.log("Prompt:", prompt); // 必要に応じてプロンプトもログ出力
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: OLLAMA_MODEL,
                            prompt: prompt,
                            stream: false // ストリーミングなし
                        }),
                        signal: abortSignal // AbortControllerのシグナル
                    });

                    if (!response.ok) {
                        let errorBody = '応答ボディの取得に失敗しました。';
                        try {
                            errorBody = await response.text();
                        } catch (e) { console.error("Error reading error response body:", e); }
                        console.error("API Error Response:", response.status, response.statusText, errorBody);
                        throw new Error(`APIエラー (${response.status}): ${response.statusText}. ${errorBody}`);
                    }

                    const data = await response.json();
                    // console.log("API Response Data:", data); // デバッグ用
                    if (data && data.response) {
                        return data.response;
                    } else {
                        throw new Error("API応答の形式が不正です (responseフィールドが見つかりません)。");
                    }

                } catch (error) {
                     if (error.name === 'AbortError') {
                         console.log('APIリクエストがキャンセルされました。');
                         // AbortErrorは呼び出し元で処理するため、ここでは再スローしないか、特定の情報を返す
                         throw error; // 再スローして呼び出し元で判定
                     }
                     console.error("API呼び出し中に予期せぬエラー:", error);
                     // fetch 자체의 에러 (네트워크 문제 등)
                     throw new Error(`API通信に失敗しました: ${error.message}`);
                }
            }

            // --- イベントハンドラ ---

            // 問題生成処理
            async function handleGenerateQuestion() {
                // 既存のリクエストがあればキャンセル
                appState.generateAbortController?.abort();
                appState.generateAbortController = new AbortController();

                const difficulty = difficultySelect.value;
                const systemPrompt = systemPromptTextarea.value;
                const knowledge = knowledgeInput.value;

                if (!knowledge.trim()) {
                    alert("知識ベースを入力してください。");
                    knowledgeInput.focus();
                    return;
                }

                updateUIState('generating');
                resetQuizUI();

                const combinedPrompt = `${systemPrompt}\n\n知識ベース:\n${knowledge}\n\n難易度: ${difficulty}`;
                let rawResponse = ''; // エラー表示用に保持

                try {
                    // API呼び出しとタイムアウト処理
                    const apiPromise = callOllamaAPI(
                        API_ENDPOINTS.generate,
                        combinedPrompt,
                        appState.generateAbortController.signal
                    );
                    const timeoutPromise = new Promise((_, reject) =>
                         setTimeout(() => reject(new Error(`リクエストがタイムアウトしました (${API_TIMEOUT / 1000}秒)`)), API_TIMEOUT)
                    );

                    rawResponse = await Promise.race([apiPromise, timeoutPromise]);

                    const parsedData = parseQuestionResponse(rawResponse);

                    // クイズ状態更新
                    appState.currentQuiz = parsedData;
                    appState.userSelection = null; // 選択をリセット

                    // UI更新
                    questionText.textContent = parsedData.question;
                    optionTexts.A.textContent = parsedData.options.A;
                    optionTexts.B.textContent = parsedData.options.B;
                    optionTexts.C.textContent = parsedData.options.C;
                    optionTexts.D.textContent = parsedData.options.D;

                    updateUIState('generated');

                } catch (error) {
                     console.error("問題生成エラー:", error);
                     if (error.name !== 'AbortError') { // キャンセル以外のエラーの場合
                         generateErrorDetails.textContent = `${error.message}\n\n--- 受信した応答 (一部) ---\n${rawResponse.substring(0, 200)}${rawResponse.length > 200 ? '...' : ''}`; // エラーメッセージと応答の一部を表示
                         updateUIState('error_generate');
                     } else {
                         // キャンセルされた場合は初期状態に戻すなど検討
                          updateUIState('initial'); // または generating のままにするか
                     }
                } finally {
                     // AbortControllerをクリア
                     appState.generateAbortController = null;
                }
            }

            // 回答評価処理
            async function handleEvaluateAnswer() {
                appState.evaluateAbortController?.abort();
                appState.evaluateAbortController = new AbortController();

                if (!appState.userSelection) {
                    alert("選択肢を選んでください。");
                    return;
                }
                const userFreeText = userInput.value.trim();

                updateUIState('submitting');
                feedbackContainer.classList.remove('visible', 'feedback-correct', 'feedback-incorrect');
                let rawResponse = '';

                // 評価プロンプトの生成
                const evaluationPrompt = `
あなたは教育目的のクイズ評価AIです。公平かつ客観的に評価してください。
以下の情報に基づいてユーザーの回答を評価し、フィードバックを提供してください：

**問題:** ${appState.currentQuiz.question}
**選択肢:**
A: ${appState.currentQuiz.options.A}
B: ${appState.currentQuiz.options.B}
C: ${appState.currentQuiz.options.C}
D: ${appState.currentQuiz.options.D}
**正解:** ${appState.currentQuiz.correctAnswer}
**ユーザーの選択:** ${appState.userSelection} (${appState.currentQuiz.options[appState.userSelection]})
**ユーザーの追加回答/質問:** ${userFreeText || "なし"}

**指示:**
1. まず、ユーザーの選択が正解か不正解かを明確に判定してください。出力は「判定: 正解」または「判定: 不正解」から始めてください。
2. 次に、判定の根拠となる簡潔な説明をしてください。「説明: 」で始めてください。正解の選択肢 (例: C) とその内容も明確に示してください。
3. もしユーザーが追加の回答や質問を記述していた場合は、それに対して建設的かつ丁寧に応答してください。「追加回答について: 」で始めてください。記述がない場合はこのセクションは不要です。
4. 最後に、学習に役立つ可能性のある追加情報や関連知識があれば提供してください。「追加情報: 」で始めてください。必須ではありません。
5. 各セクション（判定、説明、追加回答について、追加情報）は改行で区切ってください。

**出力例 (正解の場合):**
判定: 正解
説明: その通りです！正解は ${appState.currentQuiz.correctAnswer} (${appState.currentQuiz.options[appState.currentQuiz.correctAnswer]}) です。木星は太陽系で最大の惑星です。
追加回答について: ご指摘の通り、木星の大赤斑は巨大な嵐ですね。素晴らしい知識です！
追加情報: 木星はガリレオ・ガリレイによって発見された4つの大きな衛星（ガリレオ衛星）を持っています。

**出力例 (不正解の場合):**
判定: 不正解
説明: 残念！正解は ${appState.currentQuiz.correctAnswer} (${appState.currentQuiz.options[appState.currentQuiz.correctAnswer]}) です。木星が太陽系で最大の惑星です。あなたが選択した ${appState.userSelection} (${appState.currentQuiz.options[appState.userSelection]}) は、[不正解の理由や特徴など]。
追加情報: 土星はその美しい環で有名ですが、大きさでは木星に次いで2番目です。
`;

                try {
                    const apiPromise = callOllamaAPI(
                        API_ENDPOINTS.evaluate,
                        evaluationPrompt,
                        appState.evaluateAbortController.signal
                    );
                    const timeoutPromise = new Promise((_, reject) =>
                         setTimeout(() => reject(new Error(`リクエストがタイムアウトしました (${API_TIMEOUT / 1000}秒)`)), API_TIMEOUT)
                    );

                    rawResponse = await Promise.race([apiPromise, timeoutPromise]);
                    const parsedFeedback = parseEvaluationResponse(rawResponse);
                    const isCorrect = parsedFeedback.judgement === "正解";

                    // UI更新
                    feedbackContainer.className = "feedback-container visible " + (isCorrect ? "feedback-correct" : "feedback-incorrect");
                    feedbackHeader.textContent = isCorrect ? "🎉 正解です！" : "🤔 不正解です";

                    // フィードバック内容をHTML形式で整形して表示
                    let feedbackHTML = `<div class="explanation"><strong>説明:</strong><br>${sanitizeText(parsedFeedback.explanation)}</div>`;
                    if (parsedFeedback.userResponseFeedback) {
                        feedbackHTML += `<div class="user-response"><h4>あなたの追加回答/質問について:</h4><p>${sanitizeText(parsedFeedback.userResponseFeedback)}</p></div>`;
                    }
                    if (parsedFeedback.additionalInfo) {
                        feedbackHTML += `<div class="additional-resources"><h4>追加情報:</h4><p>${sanitizeText(parsedFeedback.additionalInfo)}</p></div>`;
                    }
                    safeRenderHTML(feedbackContent, feedbackHTML);

                    updateUIState('submitted');

                } catch (error) {
                     console.error("回答評価エラー:", error);
                     if (error.name !== 'AbortError') {
                         submitErrorDetails.textContent = `${error.message}\n\n--- 受信した応答 (一部) ---\n${rawResponse.substring(0, 200)}${rawResponse.length > 200 ? '...' : ''}`;
                         updateUIState('error_submit');
                     } else {
                         updateUIState('generated'); // キャンセルされたら回答可能な状態に戻す
                     }
                } finally {
                    appState.evaluateAbortController = null;
                }
            }

            // 次の問題へ
            function handleNextQuestion() {
                 // 状態を初期化
                 appState.currentQuiz = { question: "", options: {}, correctAnswer: "" };
                 appState.userSelection = null;
                 userInput.value = '';
                 resetQuizUI();
                 updateUIState('initial');
                 // 設定パネルまでスクロールし、生成ボタンにフォーカス
                 settingsPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                 generateBtn.focus();
            }

             // 選択肢の選択ハンドラ (Event Delegation)
             function handleOptionSelect(event) {
                 // ラジオボタン自身の変更イベントを拾う
                 if (event.target.type === 'radio' && event.target.name === 'quizOption') {
                     const selectedValue = event.target.value;
                     appState.userSelection = selectedValue;

                     // UI更新（選択状態の強調表示）
                     Object.values(optionLabels).forEach(label => {
                         label.classList.remove('selected');
                     });
                     if (optionLabels[selectedValue]) {
                         optionLabels[selectedValue].classList.add('selected');
                     }
                     // 送信ボタンの状態を更新
                      updateUIState(appState.status); // status自体は変えず、ボタン状態だけ更新
                 }
             }

            // --- UIリセット関数 ---
            function resetQuizUI() {
                questionText.textContent = ''; // 空にする
                Object.values(optionTexts).forEach(el => el.textContent = '');
                radioInputs.forEach(input => {
                     input.checked = false;
                     input.disabled = true; // デフォルトは無効
                 });
                Object.values(optionLabels).forEach(label => {
                     label.classList.remove('selected');
                     label.style.cursor = 'default';
                     label.style.opacity = '0.7';
                 });
                feedbackContainer.classList.remove('visible', 'feedback-correct', 'feedback-incorrect');
                feedbackContent.innerHTML = '';
                // userInput.value = ''; // 必要に応じてクリア
            }

            // --- 初期化 ---
            function init() {
                // イベントリスナー
                generateBtn.addEventListener('click', handleGenerateQuestion);
                submitBtn.addEventListener('click', handleEvaluateAnswer);
                nextQuestionBtn.addEventListener('click', handleNextQuestion);
                 // 選択肢グループにイベントリスナー (changeイベントで十分)
                 if (optionGroup) {
                     optionGroup.addEventListener('change', handleOptionSelect);
                 } else { console.error("Element .option-group not found."); }

                // 初期状態設定
                resetQuizUI(); // まずUIをリセット
                updateUIState('initial'); // 初期状態に設定
            }

            // --- アプリケーション開始 ---
            init();
        });
    </script>
</body>
</html>